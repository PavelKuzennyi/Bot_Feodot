using System;
using System.IO;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
using Bot_Feodot;
using Telegram.Bot;
using Telegram.Bot.Exceptions;
using Telegram.Bot.Extensions.Polling;
using Telegram.Bot.Types;
using Telegram.Bot.Types.Enums;
using Telegram.Bot.Types.ReplyMarkups;

var botClient = new TelegramBotClient("5250704485:AAGO-A4Lt8BTdkFxwjrCIAUgu-mNkVtOscg");

using var cts = new CancellationTokenSource();

// StartReceiving does not block the caller thread. Receiving is done on the ThreadPool.
var receiverOptions = new ReceiverOptions
{
    AllowedUpdates = { } // receive all update types
};
botClient.StartReceiving(
    HandleUpdateAsync,
    HandleErrorAsync,
    receiverOptions,
    cancellationToken: cts.Token);

var me = await botClient.GetMeAsync();

Console.WriteLine($"Start listening for @{me.Username}");
Console.ReadLine();

// Send cancellation request to stop bot
cts.Cancel();

async Task HandleUpdateAsync(ITelegramBotClient botClient, Update update, CancellationToken cancellationToken)
{
    Random rnd = new();
    
    // Only process Message updates: https://core.telegram.org/bots/api#message
    if (update.Type != UpdateType.Message)
        return;
    if (update.Message!.Type != MessageType.Text)
        return;

    // Only process text messages

    var chatId = update.Message.Chat.Id;
    if (chatId == -1001354844390)
    {
        return;
    }
    var messageText = update.Message.Text?.Split('@')[0];
    string[]? messageWords = messageText?.Split(' ');

    Console.WriteLine($"Received a '{messageText}' message in chat {chatId}."); 
    
        //await Shariy();
    
    async Task Shiza()
    {
        int voiceNumber = rnd.Next(1, 13);
        Message message;
        await using (var stream = System.IO.File.
            OpenRead($@"C:\Users\38050\RiderProjects\Bot_Feodot\Bot_Feodot\shiz\{voiceNumber}.ogg")) 
        {
            message = await botClient.SendVoiceAsync(
                chatId: chatId,
                voice: stream,
                cancellationToken: cancellationToken);
        }
    }

    async Task Voice()
    {
        int voiceNumber = rnd.Next(1, 11);
        Message message;
        await using (var stream = System.IO.File.
            OpenRead($@"C:\Users\38050\RiderProjects\Bot_Feodot\Bot_Feodot\{voiceNumber}.ogg")) 
        {
            message = await botClient.SendVoiceAsync(
                chatId: chatId,
                voice: stream,
                cancellationToken: cancellationToken);
        }
    }
    
    async Task Quote()
    {
        /*StreamReader sr = new(@"C:\Users\38050\RiderProjects\Bot_Feodot\Bot_Feodot\marx.txt");
        var quotes = sr.ReadToEnd().Split('\n');        */
        
        var quotes = DownLoadHtml.HtmlRead(rnd.Next(1, 231));
        var quote = quotes[rnd.Next(0, quotes.Count)];
        Message message = await botClient.SendTextMessageAsync(
            chatId: chatId,
            text: quote,
            cancellationToken: cancellationToken);
    }
    
    async Task Shariy()
    {
        var links = DownLoadHtml.HtmlRead("https://www.youtube.com/user/SuperSharij/videos");
        var link = "https://www.youtube.com/"+links[1];
        StreamReader sr = new(@"C:\Users\38050\RiderProjects\Bot_Feodot\Bot_Feodot\shariy.txt");
        var shariy = sr.ReadToEnd().Split("\n");
        sr.Close();
        if (!shariy.Contains(link))
        {
            await using (StreamWriter sw = new(
                @"C:\Users\38050\RiderProjects\Bot_Feodot\Bot_Feodot\shariy.txt",
                false, System.Text.Encoding.Default))
            {
                await sw.WriteLineAsync(link+"\n");
                sw.Close();
            }
            Message message = await botClient.SendTextMessageAsync(
                chatId: chatId,
                text: link,
                cancellationToken: cancellationToken);
        }
    }


    async Task Frequency()
    {
        if (messageWords[^1].All(char.IsDigit))
        {
            if (messageWords?[^1].Length < 10)
            {
                int randomScale = int.Parse(messageWords?[^1] ?? "10");
                await using (StreamWriter sw = new(
                    @"C:\Users\38050\RiderProjects\Bot_Feodot\Bot_Feodot\timer.txt",
                    false, System.Text.Encoding.Default))
                {
                    await sw.WriteLineAsync(randomScale.ToString());
                    sw.Close();
                }
                
                Message message = await botClient.SendTextMessageAsync(
                    chatId: chatId,
                    text: $"Хорошо, теперь буду высираться раз в {randomScale} сообщений",
                    cancellationToken: cancellationToken);
            }

            else
            {
                Message message = await botClient.SendTextMessageAsync(
                    chatId: chatId,
                    text: $"Игорь пошёл нахуй",
                    cancellationToken: cancellationToken);
            }
        }
    }

    if (messageWords != null && messageWords.Contains("Ф") 
                             && (messageWords.Contains("пизди") || messageWords.Contains("пиздите") ))
    {
        await Frequency();
    }
    
    if (messageWords != null && messageWords.Contains("Ф") 
                             && (messageWords.Contains("Маркс") || messageWords.Contains("маркс") 
                                                                || messageWords.Contains("Маркса") 
                                                                || messageWords.Contains("маркса")))
    {
        await Quote();
    }

    else switch (messageText)
    {
        case "/voice" :
            await Voice();
            break;
        case "/shiza":
            await Shiza();
            break;
        case "/cytata":
            await Quote();
            break;
        case "/shariy":
            await Shariy();
            break;
        default:
            StreamReader sr = new(@"C:\Users\38050\RiderProjects\Bot_Feodot\Bot_Feodot\timer.txt");
            var frequency = int.Parse(sr.ReadToEnd());
            sr.Close();
            if (rnd.Next(0, frequency) == 0 || messageText == "Ф")
            {
                switch (rnd.Next(0, 3))
                {
                    case 0:
                        await Voice();
                        break;
                    case 1:
                        await Shiza();
                        break;
                    case 2:
                        await Quote();
                        break;
                }
            }
            break;   
    }

}

Task HandleErrorAsync(ITelegramBotClient botClient, Exception exception, CancellationToken cancellationToken)
{
    var ErrorMessage = exception switch
    {
        ApiRequestException apiRequestException
            => $"Telegram API Error:\n[{apiRequestException.ErrorCode}]\n{apiRequestException.Message}",
        _ => exception.ToString()
    };

    Console.WriteLine(ErrorMessage);
    return Task.CompletedTask;
}